<script>
    const colorDropdown = document.getElementById('colorDropdown');
    const timerImage = document.getElementById('timerImage');
    const setupContainer = document.getElementById('setup');
    const timerContainer = document.getElementById('timer');
    const assignmentDisplay = document.getElementById('assignmentDisplay');
    const deadlineDisplay = document.getElementById('deadlineDisplay');
    const countdownDisplay = document.getElementById('countdown');
    const assignmentInput = document.getElementById('assignmentName');
    const deadlineInput = document.getElementById('deadline');
    let timerInterval;

    // Step 1: Get or Generate Widget ID
    let widgetId = localStorage.getItem('widgetId'); // Check if widgetId exists in localStorage

    if (!widgetId) {
        const urlParams = new URLSearchParams(window.location.search);
        widgetId = urlParams.get('id') || `widget-${Date.now()}`; // Generate a new one if not found
        localStorage.setItem('widgetId', widgetId); // Save it to localStorage for future use
    }

    // Expose functions globally
    window.startCountdown = startCountdown;
    window.editCountdown = editCountdown;

    // Step 2: Load Data on Page Load
    window.addEventListener('load', () => {
        const savedAssignment = localStorage.getItem(`${widgetId}_assignmentName`);
        const savedDeadline = localStorage.getItem(`${widgetId}_deadline`);
        const savedColor = localStorage.getItem(`${widgetId}_selectedColor`);
        const savedImage = localStorage.getItem(`${widgetId}_selectedImage`);

        if (savedAssignment && savedDeadline && savedColor && savedImage) {
            // Restore widget state
            setupContainer.style.display = 'none';
            timerContainer.style.display = 'block';

            assignmentDisplay.textContent = savedAssignment;
            deadlineDisplay.textContent = formatDate(new Date(savedDeadline));
            countdownDisplay.style.color = savedColor;
            timerImage.src = savedImage;
            timerContainer.style.backgroundColor = hexToRgba(savedColor, 0.1);

            // Start the countdown
            updateCountdown(new Date(savedDeadline));
            timerInterval = setInterval(() => updateCountdown(new Date(savedDeadline)), 1000);
        }
    });

    // Step 3: Start Countdown
    function startCountdown() {
        const assignmentName = assignmentInput.value;
        const deadline = new Date(deadlineInput.value);
        const selectedOption = colorDropdown.options[colorDropdown.selectedIndex];
        const selectedColor = selectedOption.value;
        const selectedImage = selectedOption.dataset.image;

        if (!assignmentName || isNaN(deadline.getTime())) {
            alert('Please enter a valid assignment name and deadline!');
            return;
        }

        // Save data to localStorage
        localStorage.setItem(`${widgetId}_assignmentName`, assignmentName);
        localStorage.setItem(`${widgetId}_deadline`, deadline.toISOString());
        localStorage.setItem(`${widgetId}_selectedColor`, selectedColor);
        localStorage.setItem(`${widgetId}_selectedImage`, selectedImage);

        // Update the image and container styles
        timerImage.src = selectedImage;
        timerContainer.style.backgroundColor = hexToRgba(selectedColor, 0.1);

        // Set display values
        setupContainer.style.display = 'none';
        timerContainer.style.display = 'block';
        assignmentDisplay.textContent = assignmentName;
        deadlineDisplay.textContent = formatDate(deadline);
        countdownDisplay.style.color = selectedColor;

        // Start countdown
        clearInterval(timerInterval);
        updateCountdown(deadline);
        timerInterval = setInterval(() => updateCountdown(deadline), 1000);
    }

    // Step 4: Update Countdown Display
    function updateCountdown(deadline) {
        const now = new Date();
        const timeLeft = deadline - now;

        if (timeLeft <= 0) {
            countdownDisplay.textContent = 'Time is up!';
            clearInterval(timerInterval);
            return;
        }

        const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

        countdownDisplay.textContent =
            `${days} days, ${hours} hours, ${minutes} minutes, ${seconds} seconds left`;
    }

    // Step 5: Edit Countdown (Clear Data and Reset)
    function editCountdown() {
        clearInterval(timerInterval);
        localStorage.removeItem(`${widgetId}_assignmentName`);
        localStorage.removeItem(`${widgetId}_deadline`);
        localStorage.removeItem(`${widgetId}_selectedColor`);
        localStorage.removeItem(`${widgetId}_selectedImage`);
        setupContainer.style.display = 'block';
        timerContainer.style.display = 'none';
    }

    // Helper: Convert HEX to RGBA
    function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    // Helper: Format Date
    function formatDate(date) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const daysLeft = Math.ceil((date - new Date()) / (1000 * 60 * 60 * 24));
        return `${date.toLocaleDateString(undefined, options)} (${daysLeft} days left)`;
    }
</script>
